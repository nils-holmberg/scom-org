---
execute:
  eval: true
  echo: true
  output: true
engine: knitr
format:
  html:
    toc: false
    number-sections: false
    colorlinks: true
    theme: default
title: scom-org colab
---

```{r, purl=T}
#| eval: true
#| output: true
if (T) {
# load packages
library("lme4")
library("tidyverse")
library("quarto")
# clear workspace
rm(list=ls())
}
```

```{r, purl=T}
#| eval: true
#| output: true
# working directory
if (!grepl("/qmd", getwd(), fixed=T)) {setwd("qmd/")}; getwd();
# load functions
vals_normalize <- function(x,y) {return (data.frame(id=x, nv=(y - min(y)) / (max(y) - min(y))))}
# load fb post dataset
fn = "https://raw.githubusercontent.com/nils-holmberg/scom-org/main/csv/fb-sa-230314.csv"
fn = "../csv/fb-sa-230314.csv"
dtp = read.table(fn, sep='\t', header=T, strip.white=TRUE, stringsAsFactors=FALSE)
dtp = dtp |> mutate(month=month-30)
```

## 230329: sentiment analysis


```{r, purl=F}
dtp |> select(org_type, org) |> group_by(org_type) |> summarize(count_distinct=n_distinct(org))
if (F) {
knitr::knit_exit()
#exit()
#q()
#stop("here..")
}
```

## 230523: growth analysis (cont.)

### independent variables, ivs

```{r, purl=T}
#| eval: true
#| output: true
# dv1
tmp0 = dtp |> 
select(c(1,3,22,11)) |> 
group_by(org) |> 
group_modify(~ vals_normalize(.x$id, .x$e_index)) |>
rename(e_index_norm=nv)
# iv1
tmp1 = dtp |> 
select(c(1,3,22,14)) |> 
group_by(org) |> 
group_modify(~ vals_normalize(.x$id, .x$sa_val)) |>
rename(sa_val_norm=nv)
# iv2
tmp2 = dtp |> 
select(c(1,3,22,24)) |> 
group_by(org) |> 
group_modify(~ vals_normalize(.x$id, .x$sa_int)) |>
rename(sa_int_norm=nv)
# iv3
tmp3 = dtp |> 
select(c(1,3,22,6)) |> 
group_by(org) |> 
group_modify(~ vals_normalize(.x$id, .x$follow)) |>
rename(follow_norm=nv)
# iv4
tmp4 = vals_normalize(dtp$id, dtp$time) |> as_tibble() |> rename(time_norm=nv)
# combine
tmp = tmp0 |> 
left_join(dtp |> select(id, month, org_type), by=c("id")) |> 
left_join(tmp1, by=c("id")) |> 
left_join(tmp2, by=c("id")) |> 
left_join(tmp3, by=c("id")) |> 
left_join(tmp4, by=c("id")) |> rename(org=org.x)
#
m1 = lmer(data=tmp, e_index_norm ~ sa_val_norm + sa_int_norm + follow_norm + time_norm + (1|org))
#m1 = lmer(data=tmp, e_index_norm ~ sa_val_norm + sa_int_norm + follow_norm + (1|org) + (1|as.factor(month)))
```

## 230418: growth analysis (cont.)

```{r, purl=T}
#| eval: true
#| output: true
# load functions
source("socm_sa_functions.R")
# aggregate by org
tmp = dvs_org_aggregate(dtp)
# get org_type
tmp = tmp |> group_by(org) |> mutate(id=row_number()) |> 
left_join(dtp |> select(3, 27) |> group_by(org) |> mutate(id=row_number()), by=c("org","id"))
# aggregate by org_type
tmp = tmp |> group_by(org_type, month) |> summarize(e_index_mean=mean(e_index_mean), e_index_rel_mean=mean(e_index_rel_mean), e_index_norm_mean=mean(e_index_norm_mean), e_index_mean_norm=mean(e_index_mean_norm))
# dvs, wide to long
tmp = tmp |> 
pivot_longer(cols=3:6, names_to="dvs", values_to="e_index")
# points with trend line
tmp |> 
  ggplot(aes(x=month, y=e_index, group=org_type, color=as.factor(org_type))) +
  geom_point() + 
  geom_smooth(method=lm, se=FALSE) + 
  facet_wrap(vars(dvs), scales="free") +
  theme_bw() + 
  labs(title="engagement trend by org_type and measure", x="month", y="e_index")
```

### heatmap

```{r, purl=T}
#| eval: true
#| output: true
# heatmap e_index by time and org type
hm1 = tmp |> filter(dvs=="e_index_mean") |> ggplot(aes(x=month, y=as.factor(org_type))) + geom_raster(aes(fill=e_index))
hm2 = tmp |> filter(dvs=="e_index_mean_norm") |> ggplot(aes(x=month, y=as.factor(org_type))) + geom_raster(aes(fill=e_index))
hm3 = tmp |> filter(dvs=="e_index_norm_mean") |> ggplot(aes(x=month, y=as.factor(org_type))) + geom_raster(aes(fill=e_index))
hm4 = tmp |> filter(dvs=="e_index_rel_mean") |> ggplot(aes(x=month, y=as.factor(org_type))) + geom_raster(aes(fill=e_index))
#
hm = gridExtra::grid.arrange(hm1, hm2, hm3, hm4, ncol=2, nrow=2)
#
hm
```

```{r, purl=T}
#| eval: true
#| output: true
# long format, 8 org_type \* 60 months
tmp = dtp %>% as_tibble() %>% select(c(27,22,11)) %>% 
group_by(org_type, month) %>% summarize(e_index_mean=mean(e_index))
#
tmp %>% 
  ggplot(aes(month, e_index_mean, color=as.factor(org_type))) +
  geom_point() + 
  geom_smooth(method=lm, se=FALSE) + 
  theme_bw() + 
  labs(x="month", y="e_index_mean")
```

## 230322: growth analysis

```{r, purl=T}
#| eval: true
#| output: true
#engagement over time
tmp = dtp %>% select(c(1,27,22,11)) %>% head()
#facet plot bivariate
#p = ggplot(tmp, aes(x=org_type, y=value)) +
#  geom_bar(position='dodge', stat='summary', fun='mean') +
#  facet_wrap(vars(measure), scales="free")
#p
```

```{r, purl=T}
#| eval: true
#| output: true
# dv1
tmp1 = dtp %>% select(c(3,22,11)) %>% 
group_by(org, month) %>% summarize(e_index_mean=mean(e_index))
# dv2
tmp2 = dtp %>% mutate(e_index_rel=e_index/follow) %>% select(c(3,22,28)) %>% 
group_by(org, month) %>% summarize(e_index_rel_mean=mean(e_index_rel))
# dv3
tmp3 = left_join(dtp %>% select(c(1,3,22,11)), dtp %>% select(c(1,3,22,11)) %>% 
group_by(org) %>% group_modify(~ vals_normalize(.x$id,.x$e_index)), by=c("org","id")) %>% 
select(c(2,3,5)) %>% rename(e_index_norm=nv) %>% 
group_by(org, month) %>% summarize(e_index_norm_mean=mean(e_index_norm))
# dv4
tmp4 = left_join(tmp1, tmp1 %>% 
group_by(org) %>% group_modify(~ vals_normalize(.x$month,.x$e_index_mean)) %>% 
rename(month=id, e_index_mean_norm=nv), by=c("org","month")) %>% select(-c(3))
# dvs, join multiple
tmp = tmp1 %>% 
left_join(tmp2, by=c("org","month")) %>% 
left_join(tmp3, by=c("org","month")) %>% 
left_join(tmp4, by=c("org","month"))
# dvs, wide to long
tmp = tmp %>% 
pivot_longer(cols=3:6, names_to="dvs", values_to="e_index")
```

### engagement index, dependent variable

1. **e_index_mean**: per post e_index average per month ("raw engagement scores")
2. **e_index_mean_norm**: normalized per organization values of **e_index_mean** (1. above)
3. **e_index_norm_mean**: per post e_index normalized per organization average per month 
4. **e_index_rel_mean**: per post e_index relative to follower count average per month

```{r, purl=T}
#| eval: true
#| output: true
# line plot
lp = ggplot(
data=tmp %>% filter(org %in% c("ClownerutanGranser","lakareutangranser")), 
aes(x=month, y=e_index, group=org, color=org)) +
  geom_line(linewidth=1) +
  facet_wrap(vars(dvs), scales="free") +
  labs(title="engagement by org and measure")
lp
#  facet_wrap(~dvs)
#  facet_grid(. ~ dvs)
```

### long to wide format

```{r, purl=T}
#| eval: true
#| output: true
dtw = dtp %>% select(c(3,22,11)) %>% 
group_by(org, month) %>% summarize(e_index_mean=mean(e_index)) %>% 
pivot_wider(names_from=month, names_glue="month_{month}", values_from=e_index_mean)
# latent growth model, sem approach
library(lavaan)
#dtw %>% names() %>% sort() %>% paste0("1*",.," +", collapse=' ')
#cnt=0;for (i in dtw %>% names() %>% sort()){cat(paste0(cnt,"*",i," + "));cnt=cnt+1;}
model <- '
# intercept
i =~ 
1*month_31 + 1*month_32 + 1*month_33 + 1*month_34 + 1*month_35 + 1*month_36 + 1*month_37 + 1*month_38 + 1*month_39 + 1*month_40 + 1*month_41 + 1*month_42 + 1*month_43 + 1*month_44 + 1*month_45 + 1*month_46 + 1*month_47 + 1*month_48 + 1*month_49 + 1*month_50 + 1*month_51 + 1*month_52 + 1*month_53 + 1*month_54 + 1*month_55 + 1*month_56 + 1*month_57 + 1*month_58 + 1*month_59 + 1*month_60 + 1*month_61 + 1*month_62 + 1*month_63 + 1*month_64 + 1*month_65 + 1*month_66 + 1*month_67 + 1*month_68 + 1*month_69 + 1*month_70 + 1*month_71 + 1*month_72 + 1*month_73 + 1*month_74 + 1*month_75 + 1*month_76 + 1*month_77 + 1*month_78 + 1*month_79 + 1*month_80 + 1*month_81 + 1*month_82 + 1*month_83 + 1*month_84 + 1*month_85 + 1*month_86 + 1*month_87 + 1*month_88 + 1*month_89 + 1*month_90 
# slope
s =~ 
0*month_31 + 1*month_32 + 2*month_33 + 3*month_34 + 4*month_35 + 5*month_36 + 6*month_37 + 7*month_38 + 8*month_39 + 9*month_40 + 10*month_41 + 11*month_42 + 12*month_43 + 13*month_44 + 14*month_45 + 15*month_46 + 16*month_47 + 17*month_48 + 18*month_49 + 19*month_50 + 20*month_51 + 21*month_52 + 22*month_53 + 23*month_54 + 24*month_55 + 25*month_56 + 26*month_57 + 27*month_58 + 28*month_59 + 29*month_60 + 30*month_61 + 31*month_62 + 32*month_63 + 33*month_64 + 34*month_65 + 35*month_66 + 36*month_67 + 37*month_68 + 38*month_69 + 39*month_70 + 40*month_71 + 41*month_72 + 42*month_73 + 43*month_74 + 44*month_75 + 45*month_76 + 46*month_77 + 47*month_78 + 48*month_79 + 49*month_80 + 50*month_81 + 51*month_82 + 52*month_83 + 53*month_84 + 54*month_85 + 55*month_86 + 56*month_87 + 57*month_88 + 58*month_89 + 59*month_90
'
#
#fit1 <- growth(model, data=dtw)
#summary(fit1, standardized=TRUE)
# visualize path diagram
#install.packages('tidySEM', lib="~/lib/r-cran", dependencies=TRUE)
library(tidySEM)
#graph_sem(model=fit1)
#
#library(lavaanPlot)
#lavaanPlot(model=fit1)
#
#library("DiagrammeR")
#library("semPlot")
#semPaths(fit1, intercept = FALSE, whatLabel = "est", residuals = FALSE, exoCov = FALSE)
```

- [link](https://rstudio-pubs-static.s3.amazonaws.com/78926_5aa94ae32fae49f3a384ce885744ef4a.html)

### wide to long format

```{r, purl=T}
#| eval: true
#| output: true
dtl = dtw %>% 
pivot_longer(cols=2:61, names_to="month", values_to="e_index_mean") %>%
mutate(month=str_extract(month, "[0-9]+$")) %>% mutate_at(c("month"), as.numeric)
# line plot
lp = ggplot(
data = dtl %>% filter(org %in% c("ClownerutanGranser","lakareutangranser")), 
aes(x=month, y=e_index_mean, group=org, color=org)) +
  geom_line()
lp
```

```{r, purl=T}
#| eval: true
#| output: true
dtl %>% 
  filter(org %in% c("ClownerutanGranser","lakareutangranser")) %>% # select just two orgs
  ggplot(aes(month, e_index_mean, color = org)) +
  geom_point() + # points for observations of engagement
  geom_smooth(method = lm, se = FALSE) + # linear line
  theme_bw() + # nice theme
  labs(x = "month", y = "e_index_mean") # nice labels
```

## 230315: bivariate org type

```{r, purl=T}
#wide to long format
tmp = dtp %>% select(c(1,27,6,11,14,24)) %>% pivot_longer(cols=3:6, names_to="measure", values_to="value")
#facet plot bivariate
p = ggplot(tmp, aes(x=org_type, y=value)) +
  geom_bar(position='dodge', stat='summary', fun='mean') +
  facet_wrap(vars(measure), scales="free")
p
```

## 230314: resume analysis 

```{r, purl=F}
if (T) {
knitr::knit_exit()
#exit()
#q()
#stop("here..")
}
```

```{r, purl=F}
#| eval: false
#| output: false
if (F) {
# dependencies
install.packages("tidyverse")
install.packages("lme4")
install.packages("plyr")
install.packages("quarto")
}
```

```{r, purl=F}
#| eval: false
#| output: false
#working directory
if (!grepl("/qmd", getwd(), fixed=T)) {setwd("qmd/")}
#clear workspace
rm(list=ls())
#run qmd notebook, dont do this.. 
#quarto::quarto_render("socm_sa.qmd")
#load functions
source("../src/emo-functions.R")
```

```{r, purl=F}
#| eval: false
fn = "https://raw.githubusercontent.com/nils-holmberg/scom-org/main/csv/fb-sa-230314.csv"
fn = "../csv/fb-sa-230314.csv"
dtp = read.table(fn, sep='\t', header=T, strip.white=TRUE, stringsAsFactors=FALSE)
#dtp[9,]
#str(dtp)
#knitr::knit_exit()
```

```{r, purl=F}
#| eval: false
ggplot(dtp, aes(org_type, e_index)) +
  geom_bar(position='dodge', stat='summary', fun='mean')
```

## 230305: resume analysis 

```{r, purl=F}
if (T) {
knitr::knit_exit()
}
```

### replicate project

some explanations of code cell in markdown..

```{r, purl=F}
#| eval: false
if (F) {
# clone github repo
usethis::create_from_github("https://github.com/nils-holmberg/scom-org.git", destdir = "/content/", fork = FALSE)
# go to repo dir
setwd("/content/scom-org/")
list.files()
# delete repo dir, to start over
unlink("/content/scom-org/", recursive=TRUE)
}
```

```{r, purl=F}
#| eval: false
if (F) {
# dependencies
install.packages("tidyverse")
install.packages("lme4")
install.packages("plyr")
}
```

### start here on posit.cloud

link here [posit](https://posit.cloud)

```{r, purl=F}
#| eval: false
if (F) {
# unzip data file
unzip("../csv/fb-sa-210305.csv.zip", exdir="../csv")
}
```

```{r, purl=F}
#| eval: false
#clear workspace
rm(list=ls())
#load functions
source("../src/emo-functions.R")
#
#get records, with emojis (191119)
dfp = posts_get(fn='../csv/fb-sa-210305.csv')
#
```

```{r, purl=F}
#| eval: false
#aggregate measures by organization
colv = c("e_index","sa_val","sa_int","sa_frq","wc","follow")
dfo = orgs_aggregate(dfp, colv)
#column indices
coli = data.frame(test=names(dfo),some=1:length(names(dfo))) %>% filter(!grepl("_se|frq|wc",test)) %>% pull(some)
knitr::kable(dfo %>% as_tibble() %>% select(all_of(coli)) %>% head(), format="pipe", digits=2, caption='aggregate', booktabs=TRUE)
```

### ingest new data

```{r, purl=F}
#| eval: false
#aggregate measures by organization, add org type variable
xls = readxl::read_excel("../tmp/fb-org-type-nw.xlsx", sheet=1)
xls = readxl::read_excel("../tmp/fb-org-type-nw-ng.xlsx", sheet=1)
xls = xls %>% slice(1:125) %>% select("org","Agreed type") #select("org","Typ")
xls = rename(xls, org_type="Agreed type")
dto = left_join(dfo, xls, by=join_by(org))
knitr::kable(dto, format="pipe", digits=2, caption='aggregate, org type', booktabs=TRUE)
```

```{r, purl=F}
#| eval: false
sum(table(dto$org_type))
```

### scale up

```{r, purl=F}
#| eval: false
dtp = left_join(dfp, xls, by=join_by(org)) %>% as_tibble()
table(dtp$org_type)
sum(table(dtp$org_type))
#str(dtp)
write.table(dtp, "../csv/fb-sa-230314.csv", sep="\t", quot=T, row.names=F)
```








